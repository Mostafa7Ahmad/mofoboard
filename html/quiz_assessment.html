<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>اختبار الدورة - منصة التعلم</title>
    <link rel="stylesheet" href="css/main.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

</head>
<body class="bg-background min-h-screen">
    <!-- Quiz Header -->
    <header class="sticky top-0 z-50 bg-surface shadow-card-sm border-b border-border">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Back Button & Quiz Title -->
                <div class="flex items-center">
                    <button onclick="window.location.href='course_detail.html'" class="p-2 text-text-secondary hover:text-primary transition-micro ml-2">
                        <i class="fas fa-arrow-right text-lg"></i>
                    </button>
                    <div>
                        <h1 class="text-lg font-heading font-semibold text-text-primary">اختبار الوحدة الأولى</h1>
                        <p class="text-sm text-text-secondary">تطوير مواقع الويب الحديثة</p>
                    </div>
                </div>

                <!-- Timer & Progress -->
                <div class="flex items-center space-x-4 space-x-reverse">
                    <!-- Timer -->
                    <div class="flex items-center bg-accent-50 px-3 py-2 rounded-lg">
                        <i class="fas fa-clock text-accent ml-2"></i>
                        <span id="timer" class="text-accent font-medium">١٥:٠٠</span>
                    </div>
                    
                    <!-- Progress -->
                    <div class="hidden sm:flex items-center">
                        <span class="text-sm text-text-secondary ml-2">السؤال</span>
                        <span id="currentQuestion" class="text-sm font-medium text-primary">١</span>
                        <span class="text-sm text-text-secondary mx-1">من</span>
                        <span id="totalQuestions" class="text-sm font-medium text-primary">١٠</span>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="pb-4">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-primary h-2 rounded-full transition-normal" style="width: 10%"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Quiz Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Desktop Question Navigation Sidebar -->
            <aside class="hidden lg:block w-64 flex-shrink-0">
                <div class="bg-surface rounded-xl shadow-card-sm border border-border p-6 sticky top-24">
                    <h3 class="text-lg font-heading font-semibold text-text-primary mb-4">الأسئلة</h3>
                    <div class="grid grid-cols-5 gap-2" id="questionNavigation">
                        <!-- Question navigation buttons will be generated by JavaScript -->
                    </div>
                    
                    <!-- Legend -->
                    <div class="mt-6 space-y-2">
                        <div class="flex items-center text-sm">
                            <div class="w-4 h-4 bg-primary rounded ml-2"></div>
                            <span class="text-text-secondary">السؤال الحالي</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="w-4 h-4 bg-secondary rounded ml-2"></div>
                            <span class="text-text-secondary">تم الإجابة</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="w-4 h-4 bg-accent rounded ml-2"></div>
                            <span class="text-text-secondary">مُعلم للمراجعة</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="w-4 h-4 bg-gray-200 rounded ml-2"></div>
                            <span class="text-text-secondary">لم يتم الإجابة</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Question Content -->
            <div class="flex-1">
                <div class="bg-surface rounded-xl shadow-card-sm border border-border p-6 mb-6">
                    <!-- Question Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <span class="bg-primary text-white text-sm px-3 py-1 rounded-full ml-3">السؤال ١</span>
                            <span class="text-sm text-text-secondary">اختيار متعدد</span>
                        </div>
                        <button id="flagButton" class="p-2 text-text-secondary hover:text-accent transition-micro" title="علم للمراجعة">
                            <i class="far fa-flag text-lg"></i>
                        </button>
                    </div>

                    <!-- Question Text -->
                    <div class="mb-6">
                        <h2 class="text-xl font-heading font-semibold text-text-primary mb-4" id="questionText">
                            ما هي اللغة الأساسية المستخدمة في تطوير مواقع الويب لإنشاء هيكل الصفحة؟
                        </h2>
                        
                        <!-- Question Image (if any) -->
                        <div class="hidden mb-4" id="questionImage">
                            <img class="w-full max-w-md mx-auto rounded-lg border border-border" src="https://images.pexels.com/photos/574071/pexels-photo-574071.jpeg?auto=compress&cs=tinysrgb&w=600" alt="صورة السؤال" />
                        </div>
                    </div>

                    <!-- Answer Options -->
                    <div class="space-y-3" id="answerOptions">
                        <label class="flex items-start p-4 border border-border rounded-lg hover:border-primary cursor-pointer transition-micro">
                            <input type="radio" name="answer" value="A" class="mt-1 text-primary focus:ring-primary" />
                            <div class="mr-3 flex-1">
                                <div class="flex items-center">
                                    <span class="bg-gray-100 text-text-primary text-sm px-2 py-1 rounded ml-2">أ</span>
                                    <span class="text-text-primary">HTML</span>
                                </div>
                            </div>
                        </label>

                        <label class="flex items-start p-4 border border-border rounded-lg hover:border-primary cursor-pointer transition-micro">
                            <input type="radio" name="answer" value="B" class="mt-1 text-primary focus:ring-primary" />
                            <div class="mr-3 flex-1">
                                <div class="flex items-center">
                                    <span class="bg-gray-100 text-text-primary text-sm px-2 py-1 rounded ml-2">ب</span>
                                    <span class="text-text-primary">CSS</span>
                                </div>
                            </div>
                        </label>

                        <label class="flex items-start p-4 border border-border rounded-lg hover:border-primary cursor-pointer transition-micro">
                            <input type="radio" name="answer" value="C" class="mt-1 text-primary focus:ring-primary" />
                            <div class="mr-3 flex-1">
                                <div class="flex items-center">
                                    <span class="bg-gray-100 text-text-primary text-sm px-2 py-1 rounded ml-2">ج</span>
                                    <span class="text-text-primary">JavaScript</span>
                                </div>
                            </div>
                        </label>

                        <label class="flex items-start p-4 border border-border rounded-lg hover:border-primary cursor-pointer transition-micro">
                            <input type="radio" name="answer" value="D" class="mt-1 text-primary focus:ring-primary" />
                            <div class="mr-3 flex-1">
                                <div class="flex items-center">
                                    <span class="bg-gray-100 text-text-primary text-sm px-2 py-1 rounded ml-2">د</span>
                                    <span class="text-text-primary">Python</span>
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- Confidence Level -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-sm font-medium text-text-primary mb-3">مستوى الثقة في الإجابة:</h4>
                        <div class="flex items-center space-x-4 space-x-reverse">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="confidence" value="low" class="text-error focus:ring-error" />
                                <span class="mr-2 text-sm text-text-secondary">منخفض</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="confidence" value="medium" class="text-accent focus:ring-accent" />
                                <span class="mr-2 text-sm text-text-secondary">متوسط</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="confidence" value="high" class="text-secondary focus:ring-secondary" />
                                <span class="mr-2 text-sm text-text-secondary">عالي</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex items-center justify-between">
                    <button id="prevButton" class="px-6 py-3 bg-gray-100 text-text-secondary rounded-lg hover:bg-gray-200 transition-micro disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-arrow-right ml-2"></i>
                        السؤال السابق
                    </button>

                    <div class="flex items-center space-x-3 space-x-reverse">
                        <button id="reviewButton" class="px-4 py-3 bg-accent-50 text-accent rounded-lg hover:bg-accent-100 transition-micro">
                            <i class="fas fa-eye ml-2"></i>
                            مراجعة الإجابات
                        </button>
                        <button id="nextButton" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-700 transition-micro">
                            السؤال التالي
                            <i class="fas fa-arrow-left mr-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Mobile Question Navigation -->
                <div class="lg:hidden mt-6">
                    <div class="bg-surface rounded-xl shadow-card-sm border border-border p-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-text-primary">الأسئلة</span>
                            <span class="text-sm text-text-secondary">١ من ١٠</span>
                        </div>
                        <div class="grid grid-cols-5 gap-2" id="mobileQuestionNavigation">
                            <!-- Mobile question navigation buttons -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Answer Feedback Modal -->
    <div id="feedbackModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <div class="inline-block align-bottom bg-surface rounded-xl text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-surface px-6 pt-6 pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-heading font-semibold text-text-primary">نتيجة الإجابة</h3>
                        <button id="closeFeedback" class="text-text-secondary hover:text-text-primary">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div id="feedbackContent" class="space-y-4">
                        <!-- Feedback content will be inserted here -->
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4">
                    <button id="continueFeedback" class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-700 transition-micro">
                        متابعة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Results Modal -->
    <div id="resultsModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <div class="inline-block align-bottom bg-surface rounded-xl text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-surface px-6 pt-6 pb-4">
                    <div class="text-center mb-6">
                        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-secondary-100 mb-4">
                            <i class="fas fa-check text-secondary text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-heading font-semibold text-text-primary mb-2">تم إنهاء الاختبار!</h3>
                        <p class="text-text-secondary">إليك نتائج أدائك في هذا الاختبار</p>
                    </div>

                    <!-- Score Display -->
                    <div class="bg-primary-50 rounded-xl p-6 mb-6">
                        <div class="text-center">
                            <div class="text-4xl font-bold text-primary mb-2" id="finalScore">٨٥٪</div>
                            <p class="text-text-secondary">النتيجة النهائية</p>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mt-6">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-secondary" id="correctAnswers">٨</div>
                                <p class="text-sm text-text-secondary">إجابات صحيحة</p>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-error" id="incorrectAnswers">٢</div>
                                <p class="text-sm text-text-secondary">إجابات خاطئة</p>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-accent" id="timeSpent">١٢:٣٠</div>
                                <p class="text-sm text-text-secondary">الوقت المستغرق</p>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Comparison -->
                    <div class="mb-6">
                        <h4 class="text-lg font-heading font-semibold text-text-primary mb-3">مقارنة الأداء</h4>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-text-secondary">متوسط الدورة</span>
                                <span class="text-text-primary font-medium">٧٨٪</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-text-secondary">أدائك</span>
                                <span class="text-secondary font-medium">٨٥٪ (+٧٪)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Retake Options -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h5 class="font-medium text-text-primary">إعادة المحاولة</h5>
                                <p class="text-sm text-text-secondary">يمكنك إعادة الاختبار مرة واحدة أخرى</p>
                            </div>
                            <span class="text-sm text-accent bg-accent-50 px-2 py-1 rounded">متاح</span>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex space-x-3 space-x-reverse">
                    <button onclick="window.location.href='course_detail.html'" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-700 transition-micro">
                        العودة للدورة
                    </button>
                    <button id="retakeQuiz" class="px-4 py-2 bg-gray-200 text-text-primary rounded-lg hover:bg-gray-300 transition-micro">
                        إعادة المحاولة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <div class="inline-block align-bottom bg-surface rounded-t-xl text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full sm:rounded-xl">
                <div class="bg-surface px-6 pt-6 pb-4">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-heading font-semibold text-text-primary">مراجعة الإجابات</h3>
                        <button id="closeReview" class="text-text-secondary hover:text-text-primary">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto" id="reviewContent">
                        <!-- Review content will be generated by JavaScript -->
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-between">
                    <button id="submitQuiz" class="px-6 py-2 bg-secondary text-white rounded-lg hover:bg-secondary-700 transition-micro">
                        تسليم الاختبار
                    </button>
                    <button id="continueQuiz" class="px-6 py-2 bg-gray-200 text-text-primary rounded-lg hover:bg-gray-300 transition-micro">
                        متابعة الاختبار
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-surface border-t border-border md:hidden z-40">
        <div class="flex items-center justify-around py-2">
            <a href="course_catalog.html" class="flex flex-col items-center py-2 px-3 text-text-secondary hover:text-primary transition-micro">
                <i class="fas fa-th-large text-lg"></i>
                <span class="text-xs mt-1">الكتالوج</span>
            </a>
            <a href="student_dashboard.html" class="flex flex-col items-center py-2 px-3 text-text-secondary hover:text-primary transition-micro">
                <i class="fas fa-book-open text-lg"></i>
                <span class="text-xs mt-1">دوراتي</span>
            </a>
            <a href="quiz_assessment.html" class="flex flex-col items-center py-2 px-3 text-primary">
                <i class="fas fa-clipboard-check text-lg"></i>
                <span class="text-xs mt-1">الاختبارات</span>
            </a>
            <a href="user_profile_management.html" class="flex flex-col items-center py-2 px-3 text-text-secondary hover:text-primary transition-micro">
                <i class="fas fa-user text-lg"></i>
                <span class="text-xs mt-1">الملف الشخصي</span>
            </a>
        </div>
    </nav>

    <script>
        // Quiz Data
        const quizData = {
            title: "اختبار الوحدة الأولى",
            timeLimit: 900, // 15 minutes in seconds
            questions: [
                {
                    id: 1,
                    text: "ما هي اللغة الأساسية المستخدمة في تطوير مواقع الويب لإنشاء هيكل الصفحة؟",
                    type: "multiple-choice",
                    options: [
                        { id: "A", text: "HTML", correct: true },
                        { id: "B", text: "CSS", correct: false },
                        { id: "C", text: "JavaScript", correct: false },
                        { id: "D", text: "Python", correct: false }
                    ],
                    explanation: "HTML (HyperText Markup Language) هي اللغة الأساسية لإنشاء هيكل صفحات الويب وتحديد المحتوى."
                },
                {
                    id: 2,
                    text: "أي من التالي يُستخدم لتنسيق وتصميم صفحات الويب؟",
                    type: "multiple-choice",
                    options: [
                        { id: "A", text: "HTML", correct: false },
                        { id: "B", text: "CSS", correct: true },
                        { id: "C", text: "PHP", correct: false },
                        { id: "D", text: "MySQL", correct: false }
                    ],
                    explanation: "CSS (Cascading Style Sheets) تُستخدم لتنسيق وتصميم صفحات الويب وتحديد كيفية عرض العناصر."
                },
                {
                    id: 3,
                    text: "ما هو الغرض من استخدام JavaScript في تطوير الويب؟",
                    type: "multiple-choice",
                    options: [
                        { id: "A", text: "إنشاء قواعد البيانات", correct: false },
                        { id: "B", text: "تصميم الصفحات", correct: false },
                        { id: "C", text: "إضافة التفاعل والحركة", correct: true },
                        { id: "D", text: "إدارة الخادم", correct: false }
                    ],
                    explanation: "JavaScript تُستخدم لإضافة التفاعل والحركة لصفحات الويب وجعلها أكثر ديناميكية."
                }
            ]
        };

        // Quiz State
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let flaggedQuestions = new Set();
        let timeRemaining = quizData.timeLimit;
        let timerInterval;
        let quizCompleted = false;

        // Initialize Quiz
        document.addEventListener('DOMContentLoaded', function() {
            initializeQuiz();
            startTimer();
            generateQuestionNavigation();
            displayQuestion(0);
        });

        function initializeQuiz() {
            document.getElementById('totalQuestions').textContent = convertToArabicNumerals(quizData.questions.length);
            updateProgress();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitQuiz();
                    return;
                }
                
                timeRemaining--;
                updateTimerDisplay();
                
                // Warning when 5 minutes left
                if (timeRemaining === 300) {
                    showTimerWarning();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timerElement = document.getElementById('timer');
            
            const timeString = `${convertToArabicNumerals(minutes.toString().padStart(2, '0'))}:${convertToArabicNumerals(seconds.toString().padStart(2, '0'))}`;
            timerElement.textContent = timeString;
            
            // Change color when time is running low
            if (timeRemaining <= 300) { // 5 minutes
                timerElement.parentElement.className = 'flex items-center bg-error-50 px-3 py-2 rounded-lg';
                timerElement.className = 'text-error font-medium';
            }
        }

        function showTimerWarning() {
            // You could add a toast notification here
            console.log('5 minutes remaining!');
        }

        function generateQuestionNavigation() {
            const desktopNav = document.getElementById('questionNavigation');
            const mobileNav = document.getElementById('mobileQuestionNavigation');
            
            quizData.questions.forEach((question, index) => {
                const button = createNavigationButton(index);
                desktopNav.appendChild(button.cloneNode(true));
                mobileNav.appendChild(button);
            });
        }

        function createNavigationButton(index) {
            const button = document.createElement('button');
            button.className = 'w-8 h-8 rounded text-sm font-medium transition-micro';
            button.textContent = convertToArabicNumerals((index + 1).toString());
            button.onclick = () => displayQuestion(index);
            
            updateNavigationButtonState(button, index);
            return button;
        }

        function updateNavigationButtonState(button, index) {
            if (index === currentQuestionIndex) {
                button.className = 'w-8 h-8 rounded text-sm font-medium transition-micro bg-primary text-white';
            } else if (userAnswers[index] !== undefined) {
                button.className = 'w-8 h-8 rounded text-sm font-medium transition-micro bg-secondary text-white';
            } else if (flaggedQuestions.has(index)) {
                button.className = 'w-8 h-8 rounded text-sm font-medium transition-micro bg-accent text-white';
            } else {
                button.className = 'w-8 h-8 rounded text-sm font-medium transition-micro bg-gray-200 text-text-primary hover:bg-gray-300';
            }
        }

        function displayQuestion(index) {
            if (index < 0 || index >= quizData.questions.length) return;
            
            currentQuestionIndex = index;
            const question = quizData.questions[index];
            
            // Update question content
            document.getElementById('questionText').textContent = question.text;
            document.getElementById('currentQuestion').textContent = convertToArabicNumerals((index + 1).toString());
            
            // Update question number badge
            document.querySelector('.bg-primary.text-white.text-sm.px-3.py-1.rounded-full').textContent = `السؤال ${convertToArabicNumerals((index + 1).toString())}`;
            
            // Clear previous answers
            const answerInputs = document.querySelectorAll('input[name="answer"]');
            answerInputs.forEach(input => input.checked = false);
            
            // Load saved answer
            if (userAnswers[index]) {
                const savedInput = document.querySelector(`input[name="answer"][value="${userAnswers[index]}"]`);
                if (savedInput) savedInput.checked = true;
            }
            
            // Update flag button
            const flagButton = document.getElementById('flagButton');
            const flagIcon = flagButton.querySelector('i');
            if (flaggedQuestions.has(index)) {
                flagIcon.className = 'fas fa-flag text-lg';
                flagButton.className = 'p-2 text-accent hover:text-accent transition-micro';
            } else {
                flagIcon.className = 'far fa-flag text-lg';
                flagButton.className = 'p-2 text-text-secondary hover:text-accent transition-micro';
            }
            
            // Update navigation buttons
            document.getElementById('prevButton').disabled = index === 0;
            const nextButton = document.getElementById('nextButton');
            if (index === quizData.questions.length - 1) {
                nextButton.textContent = 'إنهاء الاختبار';
                nextButton.innerHTML = 'إنهاء الاختبار <i class="fas fa-check mr-2"></i>';
            } else {
                nextButton.innerHTML = 'السؤال التالي <i class="fas fa-arrow-left mr-2"></i>';
            }
            
            updateProgress();
            updateAllNavigationButtons();
        }

        function updateAllNavigationButtons() {
            const buttons = document.querySelectorAll('#questionNavigation button, #mobileQuestionNavigation button');
            buttons.forEach((button, index) => {
                updateNavigationButtonState(button, index);
            });
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / quizData.questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function saveAnswer() {
            const selectedAnswer = document.querySelector('input[name="answer"]:checked');
            if (selectedAnswer) {
                userAnswers[currentQuestionIndex] = selectedAnswer.value;
            }
        }

        function convertToArabicNumerals(num) {
            const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return num.toString().replace(/[0-9]/g, (digit) => arabicNumerals[parseInt(digit)]);
        }

        // Event Listeners
        document.getElementById('flagButton').addEventListener('click', function() {
            if (flaggedQuestions.has(currentQuestionIndex)) {
                flaggedQuestions.delete(currentQuestionIndex);
            } else {
                flaggedQuestions.add(currentQuestionIndex);
            }
            displayQuestion(currentQuestionIndex);
        });

        document.getElementById('prevButton').addEventListener('click', function() {
            saveAnswer();
            displayQuestion(currentQuestionIndex - 1);
        });

        document.getElementById('nextButton').addEventListener('click', function() {
            saveAnswer();
            if (currentQuestionIndex === quizData.questions.length - 1) {
                showReviewModal();
            } else {
                displayQuestion(currentQuestionIndex + 1);
            }
        });

        document.getElementById('reviewButton').addEventListener('click', function() {
            saveAnswer();
            showReviewModal();
        });

        // Answer selection
        document.addEventListener('change', function(e) {
            if (e.target.name === 'answer') {
                saveAnswer();
                updateAllNavigationButtons();
            }
        });

        function showReviewModal() {
            const modal = document.getElementById('reviewModal');
            const reviewContent = document.getElementById('reviewContent');
            
            reviewContent.innerHTML = '';
            
            quizData.questions.forEach((question, index) => {
                const reviewItem = document.createElement('div');
                reviewItem.className = 'bg-gray-50 rounded-lg p-4';
                
                const answered = userAnswers[index] !== undefined;
                const flagged = flaggedQuestions.has(index);
                
                let statusBadge = '';
                if (flagged) {
                    statusBadge = '<span class="bg-accent text-white text-xs px-2 py-1 rounded-full mr-2">مُعلم</span>';
                }
                if (answered) {
                    statusBadge += '<span class="bg-secondary text-white text-xs px-2 py-1 rounded-full">تم الإجابة</span>';
                } else {
                    statusBadge += '<span class="bg-error text-white text-xs px-2 py-1 rounded-full">لم يتم الإجابة</span>';
                }
                
                reviewItem.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="font-medium text-text-primary">السؤال ${convertToArabicNumerals((index + 1).toString())}</h4>
                        <div>${statusBadge}</div>
                    </div>
                    <p class="text-sm text-text-secondary mb-2">${question.text}</p>
                    ${answered ? `<p class="text-sm text-primary">الإجابة: ${question.options.find(opt => opt.id === userAnswers[index])?.text || 'غير محدد'}</p>` : ''}
                `;
                
                reviewContent.appendChild(reviewItem);
            });
            
            modal.classList.remove('hidden');
        }

        document.getElementById('closeReview').addEventListener('click', function() {
            document.getElementById('reviewModal').classList.add('hidden');
        });

        document.getElementById('continueQuiz').addEventListener('click', function() {
            document.getElementById('reviewModal').classList.add('hidden');
        });

        document.getElementById('submitQuiz').addEventListener('click', function() {
            document.getElementById('reviewModal').classList.add('hidden');
            submitQuiz();
        });

        function submitQuiz() {
            if (quizCompleted) return;
            
            clearInterval(timerInterval);
            quizCompleted = true;
            
            // Calculate results
            let correctAnswers = 0;
            quizData.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const correctOption = question.options.find(opt => opt.correct);
                if (userAnswer === correctOption.id) {
                    correctAnswers++;
                }
            });
            
            const score = Math.round((correctAnswers / quizData.questions.length) * 100);
            const timeSpent = quizData.timeLimit - timeRemaining;
            
            showResults(score, correctAnswers, quizData.questions.length - correctAnswers, timeSpent);
        }

        function showResults(score, correct, incorrect, timeSpent) {
            const modal = document.getElementById('resultsModal');
            
            document.getElementById('finalScore').textContent = `${convertToArabicNumerals(score.toString())}٪`;
            document.getElementById('correctAnswers').textContent = convertToArabicNumerals(correct.toString());
            document.getElementById('incorrectAnswers').textContent = convertToArabicNumerals(incorrect.toString());
            
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;
            document.getElementById('timeSpent').textContent = `${convertToArabicNumerals(minutes.toString())}:${convertToArabicNumerals(seconds.toString().padStart(2, '0'))}`;
            
            modal.classList.remove('hidden');
        }

        document.getElementById('retakeQuiz').addEventListener('click', function() {
            location.reload();
        });

        // Prevent accidental page refresh
        window.addEventListener('beforeunload', function(e) {
            if (!quizCompleted && Object.keys(userAnswers).length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>

</body>
</html>